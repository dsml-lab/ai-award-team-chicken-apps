# Pythonを用いてAPIとデータベースの構築

## Recommend API

### 概要

"みりょくどおり"の推薦モードで使用するAPIです。ユーザの現在地と目的地までの時間、寄り道にかける時間、目的地のジャンルを入力として、目的地と隠れた魅力スポットを出力します。APIはPythonのWebアプリケーションフレームワークであるAPIを利用しています。

プログラムは`./functions/recommend.py`と`./localServer.py`が該当します。`localServer.py`はサーバを立てるために必要なプログラムとなります。

### 要求

データはjson形式で受け付けています。

- ユーザ名：FirebaseのAuthenticationが設定したユーザUID

- 緯度・経度：Flutterの位置情報プラグイン([location](https://pub.dev/packages/location))で取得された値

```json
 {"user": ユーザID, "latitude": 緯度, "longitude": 経度}
```

### 応答

データはjson形式で返します。

1. 返却したスポット全てを歩いた際にかかる時間
2. 現在地に近い順番で隠れた魅力スポットの名称・緯度・経度

返却する内容は1,2を返します。時間の計算にはGoogle Cloud Platform のDistance Matrix APIを使用しています。APIとして要求されたユーザIDを元にCloud Firestoreに登録された``1:目的地までの時間,2:寄り道にかける時間,3:ジャンルに対するTrue・Falseのフラグ辞書``を参照します。また,デモ実装では下記に示すデータセットを構築し、観光・飲食店・景観に該当する久喜市の約80スポットの緯度・経度を参照して 現在地に近い順番で隠れた魅力スポットの名称・緯度・経度を返却します。

```json

{'time': 全てのスポットを回る合計時間(秒) ,隠れた魅力スポットの順番： {'name': スポットの名称, 'lat': 緯度, 'lng':経度} }
```

実際の応答例（現在地:久喜駅, 目的地までの時間:20分, 寄り道にかかる時間:10分, ジャンル:観光地・飲食店）

```json
{'0': {'name': '寒梅酒造(株)', 'lat': 36.0650049, 'lng': 139.6754501}, 'time': 1521, '1': {'name': 'Bal style えんの蔵 久喜店', 'lat': 36.0673919, 'lng': 139.6754259}, '2': {'name': '菜香閣', 'lat': 36.0786877, 'lng': 139.6614573}}
```

### 実装内容

#### 0. 初期設定

まずFirebaseの初期化を行い、リクエストを受け取ります。その後リクエストの情報からユーザIDを取得し、推薦モードで直前に選択した``1:目的地までの時間,2:寄り道にかける時間,3:ジャンルに対するTrue・Falseのフラグ辞書``のデータを取得します。

#### 1. 目的地の決定

目的地の決定には,``1.ユーザの現在地,2.目的地までの時間,3.寄り道にかける時間,4.目的地のジャンル``を利用します。

1. 目的地のジャンルから候補となるスポットを絞り込みます(以下、候補スポット)。

2. 絞り込んだスポットを対象に現在地から候補スポットまでの距離を計算して値の小さい順に並び替えます。距離計算はPythonライブラリ[geopy](https://pypi.org/project/geopy/)を用いて行い直線距離の計算を行います。(以降、直線距離はgeopyを用いて行います)

3. 現在地から候補スポット毎に時間を計算して候補スポットまでの時間が指定された**目的地までの時間**より長い場合は計算を終了します。時間計算はDistance Matrix APIを利用しています。そのため、より現実的な時間を算出することができます。移動モードは徒歩です。(以降、時間計算にはDistance Matrix APIを使用します。)

4. 目的地までの時間内に存在する候補スポットから目的地をランダムに選びます。※目的地までの時間内に存在する候補スポットが存在しない場合は現在地から最も距離が短い場所とします。

#### 2. スポットの決定

現在地から目的地までのスポットの決定には、``1.目的地, 2.スポットが格納されたデータベース, 3.現在地, 4. 目的地までの時間+寄り道にかける時間の合計``を使用します。

1. スポット毎に現在地からの直線距離を計算します。

2. 現在地から目的地までの距離を計算します。

3. 現在地から目的地までの距離よりも直線距離が短いスポットを候補スポットとします。※距離A(現在地~目的地)と距離B(現在地->スポット)が距離A>距離Bとなるスポット

4. 候補スポット毎に現在地までの距離が短い順番に並び替えます。

5. 距離が小さい候補スポット毎に、現在地~候補スポット~目的地までの時間を計算して指定された合計時間(目的地までの時間+寄り道にかける時間)を超えたときに計算を終了します。「合計時間を経過時間が超えた時の差分」が「合計時間を経過時間が超える前の差分」より大きいときに削除し、差分が小さい方を採用します。

## データセットの構築

### 概要

デモ実装では久喜市を想定して作られています。観光・飲食店・景観に該当する久喜市の約80スポットの情報をFirebaseが提供するCloud Firestore上に構築しました。このデータベースは、1.目的地と隠れた魅力スポットの推薦 と 2.スポットの紹介文と擬似的な声レビューを実装するためのスポットのレビュー情報を格納します。

プログラムは`./make_database.py`が該当します。
### データベースの構築方法

#### 1. スポットの決定方法

スポットの決定には[埼玉県が提供するオープンデータ](https://opendata.pref.saitama.lg.jp/)を用いています。自治体のオープンデータには有意義なデータが含まれており、今回使用したデータもその1部といえます。"みりょくどおり"の強みは自治体だからこそ提供できるスポットの情報を扱っている点にあります。デモの実装でも同じことを実現したかったために1.観光地・2.飲食店・3.景観に該当するスポットで紹介文や説明が存在するスポットを集めました。また、Google Cloud Platformが提供するPlace APIを利したレビュー情報を取得するためにGoogle Mapで扱われている名称にスポットの名前を書き換えました。その際に、住所が存在しないものや重複するスポットをのぞきました。その結果、約80店舗のスポットが選択されました。

##### 使用したデータの一覧

1. 観光地：[【埼玉県】観光スポット情報 観光スポット情報](https://opendata.pref.saitama.lg.jp/data/dataset/39a46be0-e015-40f8-848c-dc7709dafe95/resource/02a7e311-21a1-4d70-87d3-05b771d0be7d)・[観光地情報](https://opendata.pref.saitama.lg.jp/data/dataset/kukikankochi/resource/693da742-6ef2-4f66-8c3a-75e171011105)

2. 飲食店：[パパ・ママ応援ショップ協賛店情報（令和4年1月末現在）](https://opendata.pref.saitama.lg.jp/data/dataset/41ab105f-32b9-4bf1-9800-84ee8511bcc2/resource/103704a8-5d4c-4ada-aeec-f01448014f68)・[地元グルメ情報](https://opendata.pref.saitama.lg.jp/data/dataset/kukijimotogourmet/resource/950fbfe5-9bd7-428c-8906-70c6e9956288)

3. 景観：[【埼玉県】景観資源データベース](https://opendata.pref.saitama.lg.jp/data/dataset/keikan-saitamaken/resource/ed739cc1-2924-45d8-9e4f-0cd0e7939ab5)・[景観情報](https://opendata.pref.saitama.lg.jp/data/dataset/kukikeikan/resource/8d9a9f90-d6c4-44c7-93e6-6c614bd7cf54)

#### 2. 緯度・経度情報とレビュー情報の取得

Google Cloud Platformが提供するPlace APIを利用して緯度・経度情報とレビュー情報を取得します。レビュー情報は1スポット5つの制限が存在するため1スポット5つとしています。

#### 構築したデータベース

`./data/dataset.csv`がデータベースに登録した情報になります。一部を抜粋します。

```csv
区分,名称,GoogleMAP,概要
飲食店,創作ダイニング　紅葉,紅葉 (KUREHA クレハ),隠れ家的雰囲気がGood。お子様からご年配の方まで楽しめる幅広いメニューでお待ちしております。
飲食店,手打そば　吉田家,吉田家,体に良いものをお子様に!!をモットーに!!優待します。昔ながらの手作りで自然食、健康食｡コシと甘味のある本当のそばの味を楽しめます。
飲食店,中国料理　皇閣,皇閣,営業時間・定休日については当店にお問合せください。
飲食店,ヴィオロン,ヴィオロン,生演奏毎晩ｐｍ8：00～（ポップス、映画音楽、ジャズ弾き語り）。オーガニック野菜を中心に心のこもった手作りの料理をお出ししてます。手作りケーキ、キッシュ等。(１６時～１９時は休）
```
